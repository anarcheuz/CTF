// This service lets you view the profiles of some of our users, like "sheriff" and "badguy".

#include <pthread.h>
#include <stdlib.h>
#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <unistd.h>
#include <errno.h>
#include <stdint.h>
#include <string.h>

FILE *open_profile(FILE *in) {
  char path[256];
  strcpy(path, "user_profiles/");

  // read the username and append it to the path
  if (!fgets(path+14, 512, in)) {
    return NULL;
  }
  if (path[strlen(path)-1] == '\n') {
    path[strlen(path)-1] = '\0';
  }

  return fopen(path, "r");
}

void *handle_con(void *s_) {
  int s = (int)(intptr_t)s_;
  FILE *in = fdopen(s, "r");
  FILE *out = fdopen(dup(s), "w");
  if (!in || !out) {
    fputs("fdopen failed", stderr);
    exit(1);
  }

  FILE *profile_file = open_profile(in);
  if (profile_file == NULL) {
    fputs("sorry, but I was unable to find that profile.\n", out);
    goto out;
  }
  char buf[1024];
  size_t len;
  while (len = fread(buf, 1, 1024, profile_file)) {
    fwrite(buf, 1, len, out);
  }

out:
  fclose(in);
  fclose(out);
  return NULL;
}

int main(void) {
  int server_socket = 0;
  while (1) {
    int socket = accept(server_socket, NULL, NULL);
    if (socket < 0) perror("accept() failed"), exit(1);

    pthread_t thread_id;
    int r;
    pthread_attr_t attrs;
    if (pthread_attr_init(&attrs) || pthread_attr_setdetachstate(&attrs, PTHREAD_CREATE_DETACHED)) {
      fputs("unable to prepare pthread attrs", stderr);
      exit(1);
    }
    if ((r=pthread_create(&thread_id, &attrs, handle_con, (void*)(intptr_t)socket))) {
      errno = r;
      perror("pthread_create failed");
      exit(1);
    }
  }
}
